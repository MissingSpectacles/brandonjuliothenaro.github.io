---
date: 2020-03-19
thumbnail_src: https://png2.cleanpng.com/sh/52e1794a13ef5497fa7cf15539fd8fec/L0KzQYm3VsE1N5l8R91yc4Pzfri0jflkepD4h9h9LYP0fH76hgJ3baMyiAN1LYPogsfskr1uaZ9mf9d2ZX73PcT7lfRqd155itN3c3HmhLr2jvFtNZJzed5Ec3n2PYbpUsIxP2U1TNMAZXW1PoO8WcE3QWo2Sac7OEm4Roi6VsMxPGcziNDw/kisspng-microsoft-sql-server-sql-server-management-studio-transactional-analysis-5b2207404a5ee2.2591699115289567363046.png
thumbnail_alt: Microsoft SQL Server logo
---

# T-SQL

## About

This is my note about T-SQL when learning about database in my university. It's T-SQL because my university uses SQL Server to teach in database course.

## Data Definition Language (DDL)

### Create

#### Create Table

```sql
create table [Table_Name]
(
    [column_name] [data_type] [constraints]
)
```

#### Create Index

```sql
create index [index_name] on [Table_Name]([column_name])
```

#### Create View

```sql
create view [View_Name] ([column1], [column2], ...)
as
    [subquery]
```

### Drop

#### Drop Table

```sql
drop table [Table_Name]
```

#### Drop Index

```sql
drop index [index_name] on [Table_Name]
```

#### Drop View

```sql
drop view [view_name]
```

### Constraints

- not null
- primary key
- unique

#### Check

```sql
create table [Table_Name]
(
    [column_name] [data_type] check [column_name] [boolean_expression]
)
```

#### Default

```sql
create table [Table_Name]
(
    [column_name] [data_type] default 'lorem ipsum'
)
```

#### Foreign Key

```sql
create table Employees
(
    job_position_id int
        foreign key (job_position_id)
            references JobPositions (id)
            on delete cascade
            on update cascade
)
```

### Alter

#### Add Column

```sql
alter table [Table_Name]
add [column_name] [data_type]
```

#### Drop Column

```sql
alter table [Table_Name]
drop column [column_name]
```

#### Alter Column

```sql
alter table [Table_Name]
alter column [column_name] [data_type]
```

#### Add Constraint

```sql
alter table [Table_Name]
add constraint [constraint_name] [boolean_expression]
```

##### Add Foreign Key

```sql
alter table [Employee]
  add constraint [fk_job_position_id]
    foreign key (job_position_id) referrences [Job_Positions] (id)
      on update [cascade | set [null | default]]
      on delete [cascade | set [null | default]]
```

#### Drop Constraint

```sql
alter table [Table_Name]
drop constraint [constraint_name]
```

#### Add Default

```sql
alter table [Table_Name]
add constraint [constraint_name] default 'lorem ipsum' for [column_name]
```

### Boolean Expression

#### Conjunction

```sql
[boolean1]
and [boolean2]
or [boolean3]
```

#### Like

```sql
[column_name] like '[regex]'
```

##### ReGex

| Symbol | Meaning                 |
| ------ | ----------------------- |
| %      | Anything for any amount |
| \_     | Anything for only one   |
| [a-z]  | from 'a' to 'z'         |
| [0-9]  | from '0' to '9'         |

#### In

```sql
in ([value1], [value2], ...)
```

#### Between

```sql
between [value1] or [value2]
```

#### Exists

```sql
exists
  (
      [subquery]
  )
```

### Data Types

- int
- varchar
- date

## Data Manipulation Language (DML)

### Select

```sql
select [* | [column1, column2, ...]]
from [Table_Name]
```

#### Sorting

```sql
select [column_name]
from [Table_Name]
order by [column_name] [asc | desc]
```

### Insert

```sql
insert into [Table_Name] ([column1], [column2], ...)
values ([value1], [value2], ...)
```

### Update

```sql
update [Table_Name]
set [column_name] = [new_value]
where [boolean_expression]
```

### Delete

```sql
delete from [Table_Name]
where [boolean_expression]
```

### Commit

```sql
begin tran
    [DDL | DML]
    commit
```

### Rollback

```sql
begin tran
    [DDL | DML]
    rollback
```

### Join

#### Inner Join

```sql
select *
from Employees as e
    join JobPositions as jp
        on e.job_position_id = jp.id
```

#### Outer Join

##### Left Join

```sql
select *
from Employees as e
    left join JobPositions as jp
        on e.job_position_id = jp.id
```

##### Right Join

```sql
select *
from Employees as e
    right join JobPositions as jp
        on e.job_position_id = jp.id
```

##### Full Join

```sql
select *
from Employees as e
    full join JobPositions as jp
        on e.job_position_id = jp.id
```

### Union

```sql
[subquery1]
union
[subquery2]
```

> `subquery1` and `subquery2` both must have same columns

## Data Control Language

### Grant

```sql
grant [command1], [command2], ...
on [Database_Name]
to [public | user_name]
```

### Revoke

```sql
revoke [[command1], [command2], ...]
on [Database_Name]
from [public | user_name]
```

### Commands

- select
- insert
- update
- delete
- references
- alter
- index

## Functions

### Aggregate

- sum
- count
- avg
- min
- max

#### Grouping

```sql
select name, sum(salary)
from Employees
group by name
```

### Date

#### Datediff

```sql
datediff([date_type], [date1], [date2])
```

#### Datename

```sql
datename([date_type], [date])
```

#### Datepart

```sql
datepart([date_type], [date])
```

#### Dateadd

```sql
dateadd([date_type], [+/-][amount], [date])
```

#### Date Types

- day
- weekday
- month
- year

### String

#### Charindex

```sql
charindex([target], [string], [start_index])
```

> `[start_index]` is optional

#### Left

```sql
left([string], [length])
```

#### Right

```sql
right([string], [length])
```

#### Substring

```sql
substring([string], [start_index], [length])
```

#### Trim

```sql
rtrim([string])
ltrim([string])
```

#### Reverse

```sql
reverse([string])
```

#### Length

```sql
len([string])
```

#### Stuff

```sql
stuff([string], [start_index], [length], [replacement])
```

> A.K.A 'replace'

#### Convert

```sql
convert([data_type], [string], [date_format])
```

> `[date_format]` is optional

#### Cast

```sql
cast([string] as [data_type])
```

## Advanced

### Trigger

#### Create Trigger

```sql
create trigger [trigger_name]
    on [Table_Name]
    for [command1], [command2], ...
    as
    [subquery]
```

##### Virtual Tables

###### Inserted and Deleted

```sql
create trigger [print_on_insert]
    on Employee
    for [insert | delete]
    as
        declare
            @id int, @name varchar(20), @gender varchar(6)
select @id = id,
       @name = name,
       @gender = gender
from [inserted | deleted]
print '(' + @id + ', ' + @name + ', ' + @gender + ')'
```

#### Drop Trigger

```sql
drop trigger [trigger_name]
```

### Cursor

```sql
declare [cursor_name] cursor for
    select [column1], [column2], ...
    from [Table_Name]

open [cursor_name]

fetch next from [cursor_name]

while @@FETCH_STATUS = 0 begin
    fetch next from [cursor_name]
end

close [cursor_name]

deallocate [cursor_name]
```

#### Terminologies

| Terminology | Meaning                       |
| ----------- | ----------------------------- |
| Next        | Return the next row           |
| Prior       | Return the previous row       |
| First       | Return the first row          |
| Last        | Return the last row           |
| Absolute    | Return the n-th row           |
| Relative    | Return the current + n-th row |

## Programming in SQL with T-SQL

### Variable Declaration

```sql
declare @[var_name] [data_type]
select @[var_name] = [a_value]
print @[var_name]
```

### Selection Statement

#### If else-if else

```sql
if [boolean_expression]
    begin
        ...
    end
else
    if [boolean_expression]
        begin
            ...
        end
    else
        begin
            ...
        end
```

#### Switch Case

```sql
print case
        when [boolean1] then 'value1'
        when [boolean2] then 'value2'
        ...
        else 'valueN'
    end
```

### Loop

```sql
declare @i int = 1
while @i < 100 begin
    print @i
    select @i = @i + 1
end
```

#### Loop Keyword

- continue
- break
- return

### Procedure

#### Create Procedure

```sql
create procedure [procedure_name]
as
    [subquery]
```

#### Rename Procedure

```sql
sp_rename [old_procedure_name], [new_procedure_name]
```

#### Drop Procedure

```sql
drop procedure [procedure_name]
```

#### Print Procedure

```sql
sp_helptext [procedure_name]
```

### Error Handling

```sql
[subquery_which_might_cause_error]
if @@ERROR <> 0 begin -- <> is the same as !=
    ...
end
```

### Exception Handling

```sql
begin try
    [subquery_that_might_cause_exception]
end begin
begin catch
    print 'Error occured'
end catch
```
